server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    include /etc/nginx/snippets/security.conf;

    # API: статус (для фронта, чтобы показать узел/время)
    set $ds_node_id "local-dev";
    set $ds_city    "Local";
    set $ds_region  "Dev";
    set $ds_tz      "UTC";

    location = /api/status {
        default_type application/json;
        add_header Cache-Control no-store;
        add_header X-Node "$ds_node_id" always;
        return 200
'{"name":"$ds_node_id","city":"$ds_city","region":"$ds_region","hostname":"$hostname","time":"$time_iso8601","tz":"$ds_tz","addr":"$server_addr"}';
    }

    # API: пинг
    location = /api/ping { return 204; }

    location = /api/login {
        default_type application/json;
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With" always;
        add_header Access-Control-Allow-Methods "POST, OPTIONS, HEAD" always;

        if ($request_method = OPTIONS) { return 204; }
        if ($request_method = HEAD)    { return 200 ""; }
        if ($request_method != POST)   { return 405 '{"status":"error","message":"Method not allowed"}'; }

        return 401
'{"status":"error","message":"$login_message","error_code":"$login_error","timestamp":"$time_iso8601","request_id":"$request_id"}';
    }
}
