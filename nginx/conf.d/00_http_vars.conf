# http-level (эти директивы НЕЛЬЗЯ класть в server{})

# Rate-limit зона (http context)
limit_req_zone $binary_remote_addr zone=lim:10m rate=30r/m;

# Случайный выбор кода ошибки по request_id (http context)
split_clients "$request_id" $login_error {
    5%   "MAINTENANCE_MODE";
    10%  "ACCOUNT_LOCKED";
    10%  "RATE_LIMIT_EXCEEDED";
    *    "INVALID_CREDENTIALS";
}

# Сообщение по коду ошибки (http context)
map $login_error $login_message {
    "MAINTENANCE_MODE"    "Регистрация временно недоступна. Ведутся технические работы.";
    "ACCOUNT_LOCKED"      "Аккаунт временно заблокирован. Обратитесь в поддержку.";
    "RATE_LIMIT_EXCEEDED" "Слишком много попыток входа. Попробуйте через 5 минут.";
    default               "Неверный логин или пароль";
}
