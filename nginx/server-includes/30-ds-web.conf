# Корень: SPA/лендинг — fallback на index.html
location / { try_files $uri $uri/ /index.html; }

# HTML — не кешируем (чтобы обновления прилетали сразу)
location ~* \.html$ {
  add_header Cache-Control "no-cache, no-store, must-revalidate" always;
  add_header Pragma "no-cache" always;
  add_header Expires "0" always;
}

# Статика — долгий кеш + дублируем security-заголовки (add_header не наследуется)
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2|ttf|eot|map)$ {
  expires 1y;
  add_header Cache-Control "public, immutable, max-age=31536000" always;
  add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
  add_header X-Frame-Options DENY always;
  add_header X-Content-Type-Options nosniff always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Referrer-Policy "strict-origin" always;
  access_log off;
}

# Блокировка известных VPN/прокси путей
location ~* ^/(xray|v2ray|vmess|vless|trojan|shadowsocks|ss|ws|grpc|tunnel|proxy|admin|debug) {
  access_log off; log_not_found off;
  return 404 '{"error":"not_found"}';
}

# Служебные файлы
location ~ /\.(ht|env|git|dockerignore|gitignore|gitmodules|svn|idea) {
  access_log off; log_not_found off;
  return 404;
}

# Health
location = /health {
  default_type application/json;
  add_header Cache-Control no-store always;
  return 200 '{"status":"ok","server":"$hostname","timestamp":"$time_iso8601"}';
}
